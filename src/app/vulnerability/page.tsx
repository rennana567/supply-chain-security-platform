'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import dynamic from 'next/dynamic';

const BarChart3D = dynamic(() => import('@/components/BarChart3D'), { ssr: false });

interface Vulnerability {
  sequenceNumber: number;
  description: string;
  cweId: string;
  filePath: string;
  lineColumn: string;
}

export default function VulnerabilityPage() {
  const router = useRouter();
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [summary, setSummary] = useState({ total: 0, high: 0, medium: 0, low: 0 });
  const [searchQuery, setSearchQuery] = useState('');
  const [currentPage, setCurrentPage] = useState(1);
  const itemsPerPage = 10;

  useEffect(() => {
    // TODO: æ›¿æ¢ä¸ºçœŸå® API è°ƒç”¨
    // ç¤ºä¾‹ï¼š
    // const fetchData = async () => {
    //   const result = await api.vuln.getResult(scanId);
    //   setVulnerabilities(result.vulnerabilities);
    //   setSummary(result.summary);
    // };
    // fetchData();
    
    // æ¨¡æ‹Ÿ API è°ƒç”¨
    const mockData = {
      vulnerabilities: [
        {
          sequenceNumber: 1,
          description: 'SQL æ³¨å…¥æ¼æ´ï¼šç”¨æˆ·è¾“å…¥æœªç»è¿‡æ»¤ç›´æ¥æ‹¼æ¥åˆ° SQL æŸ¥è¯¢ä¸­',
          cweId: 'CWE-89',
          filePath: '/src/api/user.py',
          lineColumn: '45:12',
        },
        {
          sequenceNumber: 2,
          description: 'XSS è·¨ç«™è„šæœ¬æ”»å‡»ï¼šæœªå¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œ HTML è½¬ä¹‰',
          cweId: 'CWE-79',
          filePath: '/src/components/Comment.tsx',
          lineColumn: '23:8',
        },
        {
          sequenceNumber: 3,
          description: 'è·¯å¾„éå†æ¼æ´ï¼šæ–‡ä»¶è·¯å¾„æœªç»éªŒè¯ç›´æ¥ä½¿ç”¨',
          cweId: 'CWE-22',
          filePath: '/src/utils/file.js',
          lineColumn: '67:15',
        },
        {
          sequenceNumber: 4,
          description: 'ä¸å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆï¼šä½¿ç”¨ Math.random() ç”Ÿæˆå®‰å…¨ä»¤ç‰Œ',
          cweId: 'CWE-338',
          filePath: '/src/auth/token.js',
          lineColumn: '12:20',
        },
        {
          sequenceNumber: 5,
          description: 'ç¡¬ç¼–ç å¯†ç ï¼šæ•°æ®åº“å¯†ç ç›´æ¥å†™åœ¨ä»£ç ä¸­',
          cweId: 'CWE-259',
          filePath: '/src/config/database.js',
          lineColumn: '8:5',
        },
      ],
      summary: { total: 5, high: 2, medium: 2, low: 1 },
    };
    setVulnerabilities(mockData.vulnerabilities);
    setSummary(mockData.summary);
  }, []);

  const filteredVulnerabilities = vulnerabilities.filter((vuln) => {
    const matchesSearch = vuln.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
      vuln.cweId.toLowerCase().includes(searchQuery.toLowerCase());
    return matchesSearch;
  });

  const totalPages = Math.ceil(filteredVulnerabilities.length / itemsPerPage);
  const paginatedVulnerabilities = filteredVulnerabilities.slice(
    (currentPage - 1) * itemsPerPage,
    currentPage * itemsPerPage
  );

  const chartData = [
    { name: 'é«˜å±', value: summary.high, color: '#ef4444' },
    { name: 'ä¸­å±', value: summary.medium, color: '#f59e0b' },
    { name: 'ä½å±', value: summary.low, color: '#eab308' },
  ];

  const exportData = () => {
    // TODO: å®ç°çœŸå®çš„å¯¼å‡ºåŠŸèƒ½
    const csv = [
      ['åºåˆ—å·', 'æ¼æ´æè¿°', 'CWE ID', 'æ–‡ä»¶è·¯å¾„', 'è¡Œ:åˆ—'].join(','),
      ...vulnerabilities.map((v) =>
        [v.sequenceNumber, `"${v.description}"`, v.cweId, v.filePath, v.lineColumn].join(',')
      ),
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'vulnerabilities.csv';
    a.click();
  };

  return (
    <div className="min-h-screen bg-[#0a0e1a] text-white">
      {/* Header */}
      <header className="border-b border-[#1e293b] bg-[#151b2e]/50 backdrop-blur-sm">
        <div className="container mx-auto px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button
              onClick={() => router.back()}
              className="text-[#5b8def] hover:text-[#7ba5f5] transition-colors"
            >
              â† è¿”å›
            </button>
            <button
              onClick={() => router.push('/home')}
              className="text-[#10b981] hover:text-[#34d399] transition-colors"
            >
              ğŸ  è¿”å›é¦–é¡µ
            </button>
            <h1 className="text-2xl font-bold text-gradient">æ¼æ´æ£€æµ‹</h1>
          </div>
          <button
            onClick={exportData}
            className="px-4 py-2 bg-[#5b8def] hover:bg-[#7ba5f5] rounded-lg transition-all"
          >
            å¯¼å‡ºæŠ¥å‘Š
          </button>
        </div>
      </header>

      {/* Main Content */}
      <main className="container mx-auto px-6 py-8">
        {/* Summary Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          {/* Stats Card */}
          <div className="bg-[#151b2e] border border-[#1e293b] rounded-lg p-6 card-gradient">
            <h2 className="text-lg font-semibold mb-4">æ¼æ´ç»Ÿè®¡</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <div className="text-3xl font-bold text-white">{summary.total}</div>
                <div className="text-sm text-gray-400">æ€»æ¼æ´æ•°</div>
              </div>
              <div>
                <div className="text-3xl font-bold text-red-400">{summary.high}</div>
                <div className="text-sm text-gray-400">é«˜å±æ¼æ´</div>
              </div>
              <div>
                <div className="text-3xl font-bold text-orange-400">{summary.medium}</div>
                <div className="text-sm text-gray-400">ä¸­å±æ¼æ´</div>
              </div>
              <div>
                <div className="text-3xl font-bold text-yellow-400">{summary.low}</div>
                <div className="text-sm text-gray-400">ä½å±æ¼æ´</div>
              </div>
            </div>
          </div>

          {/* Bar Chart Card */}
          <div className="bg-[#151b2e] border border-[#1e293b] rounded-lg p-6 card-gradient">
            <h2 className="text-lg font-semibold mb-4">æ¼æ´ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒ</h2>
            <div className="flex justify-center items-center">
              <BarChart3D data={chartData} width={350} height={250} />
            </div>
          </div>
        </div>

        {/* Search Bar */}
        <div className="bg-[#151b2e] border border-[#1e293b] rounded-lg p-6 mb-6 card-gradient">
          <div className="flex flex-col md:flex-row gap-4">
            <div className="flex-1">
              <input
                type="text"
                placeholder="æœç´¢æ¼æ´æè¿°æˆ– CWE ID..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full px-4 py-2 bg-[#0a0e1a] border border-[#1e293b] rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#5b8def]"
              />
            </div>
          </div>
        </div>

        {/* Vulnerabilities Table */}
        <div className="bg-[#151b2e] border border-[#1e293b] rounded-lg overflow-hidden card-gradient">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-[#0a0e1a]">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-300">åºåˆ—å·</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-300">æ¼æ´æè¿°</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-300">CWE ID</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-300">æ–‡ä»¶è·¯å¾„</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-300">è¡Œ:åˆ—</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-[#1e293b]">
                {paginatedVulnerabilities.map((vuln, index) => (
                  <tr key={index} className="hover:bg-[#1e293b]/30 transition-colors">
                    <td className="px-4 py-3 text-sm text-white font-medium">{vuln.sequenceNumber}</td>
                    <td className="px-4 py-3 text-sm text-gray-300">{vuln.description}</td>
                    <td className="px-4 py-3 text-sm">
                      <span className="px-2 py-1 bg-[#5b8def]/20 text-[#5b8def] rounded text-xs">
                        {vuln.cweId}
                      </span>
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-400 max-w-xs truncate" title={vuln.filePath}>
                      {vuln.filePath}
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-400">{vuln.lineColumn}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Pagination */}
          {totalPages > 1 && (
            <div className="flex items-center justify-center gap-2 p-4 border-t border-[#1e293b]">
              <button
                onClick={() => setCurrentPage((prev) => Math.max(1, prev - 1))}
                disabled={currentPage === 1}
                className="px-3 py-1 rounded bg-[#0a0e1a] text-gray-400 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed"
              >
                ä¸Šä¸€é¡µ
              </button>
              {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (
                <button
                  key={page}
                  onClick={() => setCurrentPage(page)}
                  className={`px-3 py-1 rounded ${
                    currentPage === page
                      ? 'bg-[#5b8def] text-white'
                      : 'bg-[#0a0e1a] text-gray-400 hover:text-white'
                  }`}
                >
                  {page}
                </button>
              ))}
              <button
                onClick={() => setCurrentPage((prev) => Math.min(totalPages, prev + 1))}
                disabled={currentPage === totalPages}
                className="px-3 py-1 rounded bg-[#0a0e1a] text-gray-400 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed"
              >
                ä¸‹ä¸€é¡µ
              </button>
            </div>
          )}
        </div>

        {filteredVulnerabilities.length === 0 && (
          <div className="text-center py-12 text-gray-400">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¼æ´</div>
        )}
      </main>
    </div>
  );
}

